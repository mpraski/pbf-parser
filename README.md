# PBF Parser

Elixir parser and decoder for OpenStreetMap PBF format described in [PBF file specification](https://wiki.openstreetmap.org/wiki/PBF_Format#Encoding_OSM_entities_into_fileblocks).

## Examples

Using Stream:

```
PBFParser.Reader.stream("test.osm.pbf")
|> Stream.drop(1)
|> Stream.map(&PBFParser.Decoder.decompress_block/1)
|> Stream.map(&PBFParser.Decoder.decode_block/1)
|> Stream.each(&IO.inspect/1)
|> Stream.run()
```

Using Flow:

```
PBFParser.Reader.stream("test.osm.pbf")
|> Stream.drop(1)
|> Stream.take(1_000)
|> Flow.from_enumerable(max_demand: 50)
|> Flow.partition(max_demand: 5, stages: 5)
|> Flow.map(&PBFParser.Decoder.decompress_block/1)
|> Flow.partition(max_demand: 5, stages: 10)
|> Flow.map(&PBFParser.Decoder.decode_block/1)
|> Flow.partition(window: Flow.Window.count(20))
|> Flow.reduce(fn -> [] end, fn batch, total -> [batch | total] end)
|> Flow.emit(:state)
|> Flow.partition(max_demand: 5, stages: 1)
|> Flow.each(fn item -> IO.inspect(length(item)) end)
|> Flow.run()
```

Using Flow and collecting metrics. Those are stored in /metrics directory, graph can be generated by running `gnuplot metrics/plot.gp`:

```
Metrics.Collector.start_link([:read, :decompress, :decode])

PBFParser.stream_metric("test.osm.pbf")
|> Stream.drop(1)
|> Stream.take(1_000)
|> Flow.from_enumerable(max_demand: 50)
|> Flow.partition(max_demand: 5, stages: 5)
|> Flow.map(&PBFParser.decompress_block_metric/1)
|> Flow.partition(max_demand: 5, stages: 10)
|> Flow.map(&PBFParser.decode_block_metric/1)
|> Flow.partition(window: Flow.Window.count(20))
|> Flow.reduce(fn -> [] end, fn batch, total -> [batch | total] end)
|> Flow.emit(:state)
|> Flow.partition(max_demand: 5, stages: 1)
|> Flow.each(fn item -> IO.inspect(length(item)) end)
|> Flow.run()

Metrics.Collector.stop()
```

## To-Do

Possibly use custom GenStage producer-consumer for zlib data inflation (to reuse the same stream for consecutive blocks).